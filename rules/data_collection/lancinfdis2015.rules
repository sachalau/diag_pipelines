rule load_lancinfdis:
    params:
        host = config["db_host"],
        user = config["db_user"],
        db = config["db_name"],
    input:
        rawdata = "lancinfdis2015/raw_data.xlsx"
    run:
        import pandas, psycopg2, urllib.request, xml.etree.ElementTree as ET
        phenotypes = pandas.read_excel(input["rawdata"], skiprows=2)[["Isolate accession number", "Isoniazid", "Rifampicin", "Ethambutol", "Pyrazinamide", "Streptomycin", "Ciprofloxacin", "Moxifloxacin", "Ofloxacin", "Amikacin", "Capreomycin", "Kanamycin"]]
        conn = psycopg2.connect(host=params["host"],database=params["db"], user=params["user"])
        curr = conn.cursor()
        statement = 'SELECT "Name", "Id" FROM "Drug";'
        curr.execute(statement)
        drugs = {x[0]:x[1] for x in curr.fetchall()}
        prefix = "LancInfDis2015_"
        base = "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/"
        for index, row in phenotypes.iterrows():
            if row["Isolate accession number"].startswith("ERS"):
                sras = [] 
                for SRA_UID in [x.text for x in ET.fromstring(urllib.request.urlopen(base + "esearch.fcgi?db=sra&term=" + row["Isolate accession number"]).read()).find("IdList").findall("Id")]:
                    xml = ET.fromstring(urllib.request.urlopen(base + "efetch.fcgi?db=sra&id=" + SRA_UID).read())
                    sras.append(xml.find("EXPERIMENT_PACKAGE").find("RUN_SET").find("RUN").get("accession"))
                    sample_name = xml.find("EXPERIMENT_PACKAGE").find("SAMPLE").get("alias")
                curr.execute('INSERT INTO "Specimen" ("Name") VALUES (%s) returning "Id";', [prefix+sample_name])
                specimen_id = curr.fetchone()[0]
                for sra in sras:
                    curr.execute('INSERT INTO "Library" ("PreparedFrom", "Name") VALUES (%s, %s);', (specimen_id, sra))
            elif row["Isolate accession number"].startswith("SAM"):
                sample_name = row["Isolate accession number"]
                curr.execute('INSERT INTO "Specimen" ("Name") VALUES (%s) returning "Id";', [prefix+sample_name])
                specimen_id = curr.fetchone()[0]
                xml = ET.fromstring(urllib.request.urlopen(base + "esearch.fcgi?db=sra&term=" + row["Isolate accession number"]).read())
                for SRA_UID in [x.text for x in xml.find("IdList").findall("Id")]:
                    SRA_accession = ET.fromstring(urllib.request.urlopen(base + "efetch.fcgi?db=sra&id=" + SRA_UID).read()).find("EXPERIMENT_PACKAGE").find("RUN_SET").find("RUN").get("accession")
                    curr.execute('INSERT INTO "Library" ("PreparedFrom", "Name") VALUES (%s, %s);', (specimen_id, SRA_accession))
            else:
                sample_name = ET.fromstring(urllib.request.urlopen(base + "efetch.fcgi?db=sra&id=" + row["Isolate accession number"].split(",")[0]).read()).find("EXPERIMENT_PACKAGE").find("SAMPLE").get("alias")
                curr.execute('INSERT INTO "Specimen" ("Name") VALUES (%s) returning "Id";', [prefix+sample_name])
                specimen_id = curr.fetchone()[0]
                for lib in row["Isolate accession number"].split(","):
                    curr.execute('INSERT INTO "Library" ("PreparedFrom", "Name") VALUES (%s, %s);', (specimen_id, lib))
            for drug in drugs.keys():
                if row.get(drug, "") == "R" or row.get(drug, "") == "S":
                    curr.execute('INSERT INTO "PhenotypicDrugSusceptibilityTest" ("SpecimenId", "DrugId", "Result") VALUES (%s, %s, %s);', (specimen_id, drugs[drug], row[drug]))
        conn.commit()            
        


        
